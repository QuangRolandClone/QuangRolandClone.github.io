<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        
        <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>

        <title>Test Canteen App</title>
    </head>
    <body>
        <script>
	        window.fbAsyncInit = async function() {
	            FB.init({
	                appId      : '692592981600482',
	                cookie     : true,
	                xfbml      : true,
	                version    : 'v8.0'
	            });
	
	            var loginStateJSON = await checkLoginState();
	            statusChangeCallback(loginStateJSON);
	        };
	        
            // Javascript SDK for Facebook API
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            } (document, 'script', 'facebook-jssdk'));

            // Check login state
            function checkLoginState() {
                return new Promise((resolve, reject) => {
                    FB.getLoginStatus(function(response) {
                        resolve(response);
                    });
                });
            }

            // Called with the results from FB.getLoginStatus()
            var userToken;
            function statusChangeCallback(response) {
                if (response.status === 'connected') {
                    console.log('Logged in');
                    console.log(response);
                    userToken = response.authResponse.accessToken;
                    displayElements(true);
                }
                else {
                    console.log('Not Logged in');
                    displayElements(false);
                }
            }

            // Display the page elements based on the login state
            function displayElements(isLoggedIn) {
                if (isLoggedIn) {
                    document.getElementById('loginButton').setAttribute('style', 'display:none');
                    document.getElementById('logoutButton').setAttribute('style', 'display:block');
                    document.getElementById('displayPageFeedButton').setAttribute('style', 'display:block');
                    document.getElementById('pageFeed').setAttribute('style', 'display:block');
                }
                else {
                    document.getElementById('loginButton').setAttribute('style', 'display:block');
                    document.getElementById('logoutButton').setAttribute('style', 'display:none');
                    document.getElementById('displayPageFeedButton').setAttribute('style', 'display:none');
                    document.getElementById('pageFeed').setAttribute('style', 'display:none');
                }
            }
            
         	// Login
            async function login() {
                var loginJSON = await loginThroughFacebook();
                statusChangeCallback(loginJSON);
            }

            // Login through Facebook
            function loginThroughFacebook() {
                return new Promise((resolve, reject) => {
                    FB.login(function(response) {
                        resolve(response);
                    }, {scope: 'public_profile, email, pages_show_list, pages_manage_posts, pages_manage_metadata, pages_read_engagement, pages_manage_engagement, pages_read_user_content'});
                });
            }

            // Logout
            async function logout() {
                var logoutJSON = await logoutThroughFacebook();
                var loginStateJSON = await checkLoginState();
                statusChangeCallback(loginStateJSON);
            }

            // Logout through Facebook
            function logoutThroughFacebook() {
                return new Promise((resolve, reject) => {
                    FB.logout(function(response) {
                        resolve(response);
                    });
                });
            }
            
            // Get page feed
            function getPageFeed() {
            	var delivery = {
        				userToken: userToken
        		}
        		$.ajax({
        			type: 'GET',
        			url:  'quangrolandclone.github.io/myresource/getPageFeed',
        			data: delivery,
        			success: function(response) {
        					response = JSON.parse(response);
        					displayPageFeed(response);
        			},
        			error: function() {
        				console.log("Error");
        			}
        		});
            }
            
            // Display page feed
            function displayPageFeed(response) {
            	document.getElementById('pageFeed').innerHTML = "";
            	
            	console.log(response);
            	
            	var pageFeed = document.createElement('div');
                document.getElementById('pageFeed').appendChild(pageFeed);

                if (response.data) {
                	// Name
                    var name = document.createElement('h1');
                    name.innerHTML = "Quang Canteen";
                    pageFeed.appendChild(name);

                    // Build feed
                    var feed = document.createElement('ul');
                    pageFeed.appendChild(feed);
                    for (let i in response.data) {
                    	// Build post
                        var post = document.createElement('li');
                        feed.appendChild(post);

                        // Message
                        var message = document.createElement('div');
                        message.innerHTML = 'Post message: ' + response.data[i].message;
                        post.appendChild(message);

                        // Link
                        var link = document.createElement('div');
                        link.innerHTML = '<a href="' + response.data[i].permalink_url + '" target="_blank">Link to the post</a>';
                        post.appendChild(link);
                        
                        // Share post link
                        var sharePostLinkButtonDiv = document.createElement('div');
                        post.appendChild(sharePostLinkButtonDiv);

                        var sharePostLinkButton = document.createElement("button");
                        sharePostLinkButton.innerHTML = "Share Post Link";
                        sharePostLinkButton.onclick = function(){
                        	shareLink(response.data[i].permalink_url);
                        };
                        sharePostLinkButtonDiv.appendChild(sharePostLinkButton);
                        
                        // Get comment
                        if (response.data[i].comment) {
                        	for (let j in response.data[i].comment) {
                        		var comment = document.createElement('div');
                                var tempComment = response.data[i].comment[j].message.split("; [");
                                var tempComment2 = tempComment[1].split(";");
                                comment.innerHTML = 'Comment from ' + tempComment2[1] + ": " + tempComment[0];
                                post.appendChild(comment);
                                
                                // Get reply comment
                                if (response.data[i].comment[j].reply) {
                                	for (let k in response.data[i].comment[j].reply) {
                                		var replyComment = document.createElement('div');
                                        var tempReplyComment = response.data[i].comment[j].reply[k].message.split("; [");
                                        var tempReplyComment2 = tempReplyComment[1].split(";");
                                        replyComment.innerHTML = '- Reply from ' + tempReplyComment2[1] + ": " + tempReplyComment[0];
                                        post.appendChild(replyComment);
                                	}
                                }
                                
                             	// Reply to comment
                                // Reply to comment message
                                var replyToCommentMessageDiv = document.createElement('div');
                                post.appendChild(replyToCommentMessageDiv);

                                var replyToCommentMessage = document.createElement("input");
                                replyToCommentMessage.setAttribute("type", "text");
                                replyToCommentMessage.setAttribute("id", "replyToCommentMessage" + i + "and" + j);
                                replyToCommentMessageDiv.appendChild(replyToCommentMessage);

                                // Reply to comment button
                                var replyToCommentButtonDiv = document.createElement('div');
                                post.appendChild(replyToCommentButtonDiv);

                                var replyToCommentButton = document.createElement("button");
                                replyToCommentButton.innerHTML = "Reply";
                                replyToCommentButton.onclick = function(){
                                	var delivery = {
                                			message: document.getElementById('replyToCommentMessage' + i + "and" + j).value,
                                			commentId: response.data[i].comment[j].id,
                            				userToken: userToken
                            		}
                            		$.ajax({
                            			type: 'POST',
                            			url:  '/webrest/rest/myresource/replyToComment',
                            			data: delivery,
                            			success: function(response) {
                            					console.log(response);
                            			},
                            			error: function() {
                            				console.log("Error");
                            			}
                            		});
                                };
                                replyToCommentButtonDiv.appendChild(replyToCommentButton);
                        	}
                        }
                        
                     	// Comment to post
                        // Comment to post title
                        var commentToPostTitle = document.createElement('h4');
                        commentToPostTitle.innerHTML = "Comment to this post";
                        post.appendChild(commentToPostTitle);

                        // Comment to post message
                        var commentToPostMessageDiv = document.createElement('div');
                        post.appendChild(commentToPostMessageDiv);

                        var commentToPostMessage = document.createElement("input");
                        commentToPostMessage.setAttribute("type", "text");
                        commentToPostMessage.setAttribute("id", "commentToPostMessage" + i);
                        commentToPostMessageDiv.appendChild(commentToPostMessage);

                        // Comment to post button
                        var commentToPostButtonDiv = document.createElement('div');
                        post.appendChild(commentToPostButtonDiv);

                        var commentToPostButton = document.createElement("button");
                        commentToPostButton.innerHTML = "Comment";
                        commentToPostButton.onclick = function(){
                        	var delivery = {
                        			message: document.getElementById('commentToPostMessage' + i).value,
                        			postId: response.data[i].id,
                    				userToken: userToken
                    		}
                    		$.ajax({
                    			type: 'POST',
                    			url:  '/webrest/rest/myresource/commentToPost',
                    			data: delivery,
                    			success: function(response) {
                    					console.log(response);
                    			},
                    			error: function() {
                    				console.log("Error");
                    			}
                    		});
                        };
                        commentToPostButtonDiv.appendChild(commentToPostButton);
                    }
                }
                
             	// Post to page
                if (response.isAdmin === true) {
                    // Post to page title
                    var postToPageTitle = document.createElement('h1');
                    postToPageTitle.innerHTML = "Post to Quang Canteen";
                    pageFeed.appendChild(postToPageTitle);

                    // Post to page message
                    var postToPageMessageDiv = document.createElement('div');
                    pageFeed.appendChild(postToPageMessageDiv);

                    var postToPageMessage = document.createElement("input");
                    postToPageMessage.setAttribute("type", "text");
                    postToPageMessage.setAttribute("id", "postToPageMessage");
                    postToPageMessageDiv.appendChild(postToPageMessage);

                    // Post to page button
                    var postToPageButtonDiv = document.createElement('div');
                    pageFeed.appendChild(postToPageButtonDiv);

                    var postToPageButton = document.createElement("button");
                    postToPageButton.innerHTML = "Post to Page";
                    postToPageButton.onclick = function(){
                    	var delivery = {
                				message: document.getElementById('postToPageMessage').value,
                				userToken: userToken
                		}
                    	$.ajax({
                			type: 'POST',
                			url:  '/webrest/rest/myresource/postToPage',
                			data: delivery,
                			success: function(response) {
                					console.log(response);
                			},
                			error: function() {
                				console.log("Error");
                			}
                		});
                    };
                    postToPageButtonDiv.appendChild(postToPageButton);
                }
            }
            
            // Share link
            function shareLink(link) {
            	FB.ui({
            		display: 'popup',
            		method: 'share',
            		href: link,
            	}, function(response){
            		console.log("Share Done");
            	});
            }
        </script>

        <div class="container">
            <button id="loginButton" onclick="login();" style="display:none">Login</button>
        </div>
        
        <div class="container">
            <button id="logoutButton" onclick="logout();" style="display:none">Logout</button>
        </div>

        <div class="container">
        	<!-- Display Page Feed Button -->
            <button id="displayPageFeedButton" onclick="getPageFeed();" style="display:none">Display Page Feed</button>
            
            <!-- Page Feed -->
            <div id="pageFeed"></div>
        </div>
    </body>
</html>
