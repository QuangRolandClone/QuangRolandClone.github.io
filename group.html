<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">

        <!-- Bootstrap CSS -->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
        crossorigin="anonymous">

        <title>Test Canteen App</title>
    </head>
    <body>
        <!-- Bootstrap JavaScript -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"></script>

        <script>
            window.fbAsyncInit = async function() {
                FB.init({
                    appId      : '692592981600482',
                    cookie     : true,
                    xfbml      : true,
                    version    : 'v8.0'
                });

                var loginStateJSON = await checkLoginState();
                statusChangeCallback(loginStateJSON);
            };

            // Javascript SDK for Facebook API
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            } (document, 'script', 'facebook-jssdk'));

            // Check login state
            function checkLoginState() {
                return new Promise((resolve, reject) => {
                    FB.getLoginStatus(function(response) {
                        resolve(response);
                    });
                });
            }

            // Called with the results from FB.getLoginStatus()
            function statusChangeCallback(response) {
                if (response.status === 'connected') {
                    console.log('Logged in');
                    displayElements(true);
                    displayGroupFeed();
                }
                else {
                    console.log('Not Logged in');
                    displayElements(false);
                    window.location.href = "index.html";
                }
            }

            // Display the page elements based on the login state
            function displayElements(isLoggedIn) {
                if (isLoggedIn) {
                    document.getElementById('logoutButton').setAttribute('style', 'display:block');
                    document.getElementById('groupFeed').setAttribute('style', 'display:block');
                }
                else {
                    document.getElementById('logoutButton').setAttribute('style', 'display:none');
                    document.getElementById('groupFeed').setAttribute('style', 'display:none');
                }
            }

            // Logout
            async function logout() {
                var logoutJSON = await logoutThroughFacebook();
                var loginStateJSON = await checkLoginState();
                statusChangeCallback(loginStateJSON);
            }

            // Logout through Facebook
            function logoutThroughFacebook() {
                return new Promise((resolve, reject) => {
                    FB.logout(function(response) {
                        resolve(response);
                    });
                });
            }

            // Group
            var canteenGroupId = "993102224448949";

            // Display group feed
            async function displayGroupFeed() {
                var loginStateJSON = await checkLoginState();

                var groupFeed = document.createElement('div');
                document.getElementById('groupFeed').appendChild(groupFeed);

                // Title
                var title = document.createElement('h1');
                title.innerHTML = "Group Feed";
                groupFeed.appendChild(title);

                var canteenGroupJSON = await getGroupFeedFromAPI(canteenGroupId, loginStateJSON.authResponse.accessToken);

                if(canteenGroupJSON && !canteenGroupJSON.error) {
                    console.log(canteenGroupJSON.name + ' Feed:');
                    console.log(canteenGroupJSON);

                    if (canteenGroupJSON.feed) {
                        // Name
                        var name = document.createElement('h1');
                        name.innerHTML = canteenGroupJSON.name;
                        groupFeed.appendChild(name);

                        // Build feed
                        var feed = document.createElement('ul');
                        feed.className = "list-group";
                        groupFeed.appendChild(feed);

                        for (let i in canteenGroupJSON.feed.data) {
                            if (canteenGroupJSON.feed.data[i].message) {
                                // Build post
                                var post = document.createElement('li');
                                post.className = "list-group-item";
                                feed.appendChild(post);

                                // Message
                                var message = document.createElement('div');
                                message.innerHTML = 'Message: ' + canteenGroupJSON.feed.data[i].message;
                                post.appendChild(message);

                                // Link
                                var link = document.createElement('div');
                                link.innerHTML = '<a href="' + canteenGroupJSON.feed.data[i].permalink_url + '" target="_blank">Link to the post</a>';
                                post.appendChild(link);

                                // Get total like count of the post
                                var groupPostLikeJSON = await getGroupPostLikeFromAPI(canteenGroupJSON.feed.data[i].id, loginStateJSON.authResponse.accessToken);

                                if(groupPostLikeJSON && !groupPostLikeJSON.error && groupPostLikeJSON.likes.summary.total_count > 0) {
                                    var like = document.createElement('div');
                                    like.innerHTML = 'Total Like Count: ' + groupPostLikeJSON.likes.summary.total_count;
                                    post.appendChild(like);
                                }

                                // Like group post
                                var likeGroupPostButtonDiv = document.createElement('div');
                                post.appendChild(likeGroupPostButtonDiv);

                                var likeGroupPostButton = document.createElement("button");
                                likeGroupPostButton.innerHTML = "Like Post";
                                likeGroupPostButton.onclick = async function(){
                                    var likeGroupPostJSON = await likeThroughAPI(canteenGroupJSON.feed.data[i].id, loginStateJSON.authResponse.accessToken);

                                    if(likeGroupPostJSON && !likeGroupPostJSON.error) {
                                        console.log('Successfully Like');
                                    }
                                    else {
                                        console.log("Error:");
                                        console.log(likeGroupPostJSON);
                                    }
                                };
                                likeGroupPostButtonDiv.appendChild(likeGroupPostButton);

                                // Get comment
                                if (canteenGroupJSON.feed.data[i].comments) {
                                    for (let j in canteenGroupJSON.feed.data[i].comments.data) {
                                        if (canteenGroupJSON.feed.data[i].comments.data[j].message) {
                                            var comment = document.createElement('div');
                                            comment.innerHTML = 'Comment: ' + canteenGroupJSON.feed.data[i].comments.data[j].message;
                                            post.appendChild(comment);

                                            // Reply to comment
                                            // Reply to comment message 
                                            var replyToCommentMessageDiv = document.createElement('div');
                                            post.appendChild(replyToCommentMessageDiv);

                                            var replyToCommentMessage = document.createElement("input");
                                            replyToCommentMessage.setAttribute("type", "text");
                                            replyToCommentMessage.setAttribute("id", "replyToCommentMessage" + i + "and" + j);
                                            replyToCommentMessageDiv.appendChild(replyToCommentMessage);

                                            // Reply to comment button
                                            var replyToCommentButtonDiv = document.createElement('div');
                                            post.appendChild(replyToCommentButtonDiv);

                                            var replyToCommentButton = document.createElement("button");
                                            replyToCommentButton.innerHTML = "Reply";
                                            replyToCommentButton.onclick = async function(){
                                                var replyToCommentJSON = await commentThroughAPI(document.getElementById('replyToCommentMessage' + i + "and" + j).value, canteenGroupJSON.feed.data[i].comments.data[j].id, loginStateJSON.authResponse.accessToken);

                                                if(replyToCommentJSON && !replyToCommentJSON.error) {
                                                    console.log('Successfully Comment');
                                                }
                                                else {
                                                    console.log("Error:");
                                                    console.log(replyToCommentJSON);
                                                }
                                            };
                                            replyToCommentButtonDiv.appendChild(replyToCommentButton);
                                        }
                                    }
                                }

                                // Comment to post
                                // Comment to post title
                                var commentToPostTitle = document.createElement('h4');
                                commentToPostTitle.innerHTML = "Comment to this post";
                                post.appendChild(commentToPostTitle);

                                // Comment to post message 
                                var commentToPostMessageDiv = document.createElement('div');
                                post.appendChild(commentToPostMessageDiv);

                                var commentToPostMessage = document.createElement("input");
                                commentToPostMessage.setAttribute("type", "text");
                                commentToPostMessage.setAttribute("id", "commentToPostMessage" + i);
                                commentToPostMessageDiv.appendChild(commentToPostMessage);

                                // Comment to post button
                                var commentToPostButtonDiv = document.createElement('div');
                                post.appendChild(commentToPostButtonDiv);

                                var commentToPostButton = document.createElement("button");
                                commentToPostButton.innerHTML = "Comment";
                                commentToPostButton.onclick = async function(){
                                    var commentToPostJSON = await commentThroughAPI(document.getElementById('commentToPostMessage' + i).value, canteenGroupJSON.feed.data[i].id, loginStateJSON.authResponse.accessToken);

                                    if(commentToPostJSON && !commentToPostJSON.error) {
                                        console.log('Successfully Comment');
                                    }
                                    else {
                                        console.log("Error:");
                                        console.log(commentToPostJSON);
                                    }
                                };
                                commentToPostButtonDiv.appendChild(commentToPostButton);
                            }
                        }
                    }

                    // Post to group
                    // Post to group title
                    var postToGroupTitle = document.createElement('h1');
                    postToGroupTitle.innerHTML = "Post to " + canteenGroupJSON.name;
                    groupFeed.appendChild(postToGroupTitle);

                    // Post to group message
                    var postToGroupMessageDiv = document.createElement('div');
                    groupFeed.appendChild(postToGroupMessageDiv);

                    var postToGroupMessage = document.createElement("input");
                    postToGroupMessage.setAttribute("type", "text");
                    postToGroupMessage.setAttribute("id", "postToGroupMessage");
                    postToGroupMessageDiv.appendChild(postToGroupMessage);

                    // Post to group button
                    var postToGroupButtonDiv = document.createElement('div');
                    groupFeed.appendChild(postToGroupButtonDiv);

                    var postToGroupButton = document.createElement("button");
                    postToGroupButton.innerHTML = "Post to Group";
                    postToGroupButton.onclick = async function(){
                        var postToGroupJSON = await postToGroupThroughAPI(document.getElementById('postToGroupMessage').value, canteenGroupId, loginStateJSON.authResponse.accessToken);

                        if(postToGroupJSON && !postToGroupJSON.error) {
                            console.log('Successfully Post');
                        }
                        else {
                            console.log("Error:");
                            console.log(postToGroupJSON);
                        }
                    };
                    postToGroupButtonDiv.appendChild(postToGroupButton);
                }
                else {
                    console.log("Error:");
                    console.log(canteenGroupJSON);
                }
            }

            // Get group from API
            function getGroupFromAPI() {
                return new Promise((resolve, reject) => {
                    FB.api('/me?fields=groups', function(response) {
                        resolve(response);
                    });
                });
            }

            // Get group feed from API
            function getGroupFeedFromAPI(groupId, userToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + groupId + '?fields=name,feed{id,message,permalink_url,comments{message}}', { access_token:userToken }, function(response) {
                        resolve(response);
                    });
                });
            }

            // Get group post like from API
            function getGroupPostLikeFromAPI(groupPostId, userToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + groupPostId + '?fields=id,message,likes.summary(total_count)', { access_token:userToken }, function(response) {
                        resolve(response);
                    });
                });
            }

            // Like through API
            function likeThroughAPI(objectId, userToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + objectId + '/likes', 'post', { access_token:userToken }, function(response) {
                        resolve(response);
                    });
                });
            }

            // Comment through API
            function commentThroughAPI(message, objectId, userToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + objectId + '/comments', 'post', { message:message, access_token:userToken }, function(response) {
                        resolve(response);
                    });
                });
            }

            // Post to group through API
            function postToGroupThroughAPI(message, groupId, userToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + groupId + '/feed', 'post', { message:message, access_token:userToken }, function(response) {
                        resolve(response);
                    });
                });
            }
        </script>

        <!-- Navigation bar -->
        <nav class="navbar navbar-expand-md navbar-dark bg-dark">
            <!-- Home Button -->
            <a class="navbar-brand" href="index.html">Home</a>

            <!-- Page Button -->
            <a class="navbar-brand" id="pageButton" href="page.html">Page</a>

            <!-- Group Button -->
            <a class="navbar-brand" id="groupButton" href="group.html">Group</a>
            
            <div class="collapse navbar-collapse" id="navbar">
                <ul class="navbar-nav ml-auto"> <!-- ml-auto: stick to the right -->
                    <!-- Logout Button -->
                    <button id="logoutButton" onclick="logout();" style="display:none">Logout</button>
                </ul>
            </div>
        </nav>

        <div class="container">
            <!-- Group Feed -->
            <div id="groupFeed"></div>
        </div>
    </body>
</html>
